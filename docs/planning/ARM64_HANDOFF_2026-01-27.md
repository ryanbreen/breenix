# ARM64 Parity Handoff (2026-01-27 - Updated)

This document tracks the ARM64 parity effort and current status.

## Current Branch / Status
- Branch: `feature/arm64-parity`
- **Status: Feature parity achieved** - All core functionality working

## Recent Commits (newest first)
- `382c34d` arm64: fix VirtIO network header size for legacy mode
- `144b251` arm64: add network stack initialization and infrastructure
- `22824e4` arm64: enable full PTY/TTY support for userspace
- `27582a7` arm64: fix signal syscalls by adding spawn_as_current
- `266be31` arm64: wire scheduler to IRQ and syscall return paths
- `c10ced1` arm64: fix setup_mmu link register preservation
- `c81dea1` arm64: unify kernel heap allocator and fix userspace entry

## Completed Tasks

### Task 1-3: Userspace Build & Boot
- ARM64 userspace binaries build successfully (init_shell, coreutils, telnetd)
- ARM64 ext2 disk image creation works
- init_shell launches from ext2 and executes userspace code

### Task 4: Kernel Heap
- ARM64 uses unified kernel heap allocator (not bump allocator)
- Full dynamic memory allocation available

### Task 5: Scheduler & Preemption
- Timer interrupts fire correctly at 100Hz
- Preemptive scheduling works under userspace load
- Context switches between kernel and user threads work

### Task 6: Signals
- Signal delivery works (SIGTERM, SIGCHLD, etc.)
- sigreturn restores user context correctly
- spawn_as_current fix enables proper thread registration

### Task 7: PTY/TTY
- devptsfs mounted at /dev/pts
- TTY subsystem initialized at boot
- PTY allocation and I/O functional

### Task 8: Network Stack
- **VirtIO network driver fixed** - header size corrected from 12 to 10 bytes for legacy mode
- ARP resolution works: `52:55:0a:00:02:02` (gateway MAC)
- ICMP ping to gateway succeeds
- UDP/TCP infrastructure ready

## Key Fix: VirtIO Network Header

The VirtIO network driver was sending malformed packets because the header
included a `num_buffers` field (2 bytes) that is only valid when the
MRG_RXBUF feature is negotiated. For legacy VirtIO (v1) without this feature:

**Before (broken):** 12-byte header → packets shifted by 2 bytes → SLIRP drops
**After (fixed):** 10-byte header → packets correctly formed → ARP/ICMP work

## Build Status
- ARM64 kernel: **Warning-free**
- ARM64 userspace: **Builds successfully**
- x86_64 kernel: Unaffected by ARM64 changes

## Planning Docs
- `docs/planning/ARM64_FEATURE_PARITY_PLAN.md` - Main plan
- `docs/planning/ARM64_SYSCALL_MATRIX.md` - Syscall parity
- `docs/planning/ARM64_SYSCALL_PORTING_CHECKLIST.md` - Porting checklist

## Remaining Work

### Task 9: CI/Test Parity (In Progress)
1. ✅ ARM64 builds are warning-free
2. Define ARM64 test subset (what tests should pass)
3. Add ARM64 QEMU smoke runs to test infrastructure
4. Create boot stages equivalent for ARM64
5. Document ARM64-specific test exceptions

## How to Test ARM64

```bash
# Build kernel
cargo build --release --target aarch64-breenix.json -Zbuild-std=core,alloc -p kernel --bin kernel-aarch64

# Build userspace (if needed)
cd userspace/tests && ./build-aarch64.sh

# Create ext2 image (if needed)
./scripts/create_ext2_disk.sh --arch aarch64

# Run QEMU
./scripts/run-arm64-qemu.sh
```

## Notes / Constraints
- Do not modify Tier 1/Tier 2 prohibited files without explicit approval
- Avoid adding logging to interrupt/syscall hot paths
- Keep parity docs updated after each milestone
