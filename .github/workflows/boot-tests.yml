name: Boot Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # NOTE: x86_64 boot job temporarily removed while x86_64 build issues are
  # being resolved in a separate branch. Will be re-added once stable.
  # See docs/planning/CI_PARALLEL_BOOT_TESTS_PLAN.md for the full plan.

  arm64-boot:
    name: ARM64 Boot Test
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Init rust-fork submodule (shallow)
        run: |
          git submodule update --init --depth 1 rust-fork
          cd rust-fork && git submodule update --init --depth 1 library/stdarch library/backtrace

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-06-24
          components: rust-src, llvm-tools-preview

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-arm \
            e2fsprogs
          qemu-system-aarch64 --version

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-cargo-build-

      - name: Build userspace for aarch64
        run: |
          export PATH="$PATH:$(rustc --print sysroot)/lib/rustlib/aarch64-unknown-linux-gnu/bin"
          cd userspace/tests
          ./build.sh --arch aarch64

      - name: Create ext2 disk image
        run: |
          # Pre-create target/ as runner user so sudo doesn't own it
          mkdir -p target testdata
          sudo ./scripts/create_ext2_disk.sh --arch aarch64
          # Fix ownership of files created by sudo
          sudo chown -R $(id -u):$(id -g) target/ testdata/

      - name: Verify ext2 disk was populated
        run: |
          IMG="target/ext2-aarch64.img"
          if [ ! -f "$IMG" ]; then
            echo "FAIL: ext2 image not found at $IMG"
            exit 1
          fi
          SIZE=$(stat -c%s "$IMG")
          if [ "$SIZE" -lt 1000000 ]; then
            echo "FAIL: ext2 image suspiciously small ($SIZE bytes)"
            exit 1
          fi
          echo "ext2 image: $IMG ($SIZE bytes)"

      - name: Build ARM64 kernel
        run: |
          cargo build --release \
            --target aarch64-breenix.json \
            -Z build-std=core,alloc \
            -Z build-std-features=compiler-builtins-mem \
            -p kernel \
            --bin kernel-aarch64

      - name: Verify kernel binary
        run: |
          ls -la target/aarch64-breenix/release/kernel-aarch64
          file target/aarch64-breenix/release/kernel-aarch64

      - name: Boot ARM64 kernel in QEMU
        run: |
          OUTPUT_DIR="/tmp/breenix_aarch64_ci"
          mkdir -p "$OUTPUT_DIR"

          # Writable copy of ext2 disk for filesystem write tests
          cp target/ext2-aarch64.img "$OUTPUT_DIR/ext2-writable.img"

          # Start QEMU with 60s hard timeout
          timeout 60 qemu-system-aarch64 \
            -M virt -cpu cortex-a72 -m 512 -smp 4 \
            -kernel target/aarch64-breenix/release/kernel-aarch64 \
            -display none -no-reboot \
            -device virtio-gpu-device \
            -device virtio-keyboard-device \
            -device virtio-blk-device,drive=ext2 \
            -drive if=none,id=ext2,format=raw,file="$OUTPUT_DIR/ext2-writable.img" \
            -device virtio-net-device,netdev=net0 \
            -netdev user,id=net0 \
            -serial file:"$OUTPUT_DIR/serial.txt" &
          QEMU_PID=$!

          # Wait for userspace shell prompt (45s polling timeout)
          BOOT_OK=false
          for i in $(seq 1 45); do
            if [ -f "$OUTPUT_DIR/serial.txt" ]; then
              if grep -q "breenix>" "$OUTPUT_DIR/serial.txt" 2>/dev/null; then
                BOOT_OK=true
                break
              fi
              if grep -qiE "(KERNEL PANIC|panic!)" "$OUTPUT_DIR/serial.txt" 2>/dev/null; then
                echo "FAIL: Kernel panic detected"
                break
              fi
            fi
            sleep 1
          done

          # Clean up QEMU
          kill $QEMU_PID 2>/dev/null || true
          wait $QEMU_PID 2>/dev/null || true

          # Validate results
          if $BOOT_OK; then
            SHELL_COUNT=$(grep -o "init_shell" "$OUTPUT_DIR/serial.txt" 2>/dev/null | wc -l | tr -d ' ')
            SHELL_COUNT=${SHELL_COUNT:-0}
            if [ "$SHELL_COUNT" -le 5 ]; then
              echo "SUCCESS: ARM64 boot test passed ($SHELL_COUNT init_shell mentions)"
              exit 0
            else
              echo "FAIL: Too many init_shell mentions: $SHELL_COUNT (max 5)"
              echo "=== Serial output ==="
              cat "$OUTPUT_DIR/serial.txt"
              exit 1
            fi
          else
            echo "FAIL: ARM64 boot test failed - shell prompt not detected"
            echo "=== Serial output ==="
            cat "$OUTPUT_DIR/serial.txt" 2>/dev/null || echo "(no output)"
            exit 1
          fi

      - name: Upload serial log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: arm64-boot-log-${{ github.run_number }}
          path: /tmp/breenix_aarch64_ci/serial.txt
          if-no-files-found: warn
          retention-days: 7
